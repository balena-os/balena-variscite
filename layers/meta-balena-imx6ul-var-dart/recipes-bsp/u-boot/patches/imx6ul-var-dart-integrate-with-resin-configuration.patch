From 23a9e14b956417e95ebe824f676998126fbc73e1 Mon Sep 17 00:00:00 2001
From: Florin Sarbu <florin@balena.io>
Date: Fri, 21 Nov 2025 13:41:29 +0000
Subject: [PATCH] imx6ul-var-dart machine specific integration of balena
 environment configuration.

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Florin Sarbu <florin@balena.io>
---
 configs/imx6ul_var_dart_mmc_defconfig |  4 ++--
 include/configs/imx6ul_var_dart.h     | 15 +++++++++++----
 2 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/configs/imx6ul_var_dart_mmc_defconfig b/configs/imx6ul_var_dart_mmc_defconfig
index 3a89f9723cc..1c534c328cb 100644
--- a/configs/imx6ul_var_dart_mmc_defconfig
+++ b/configs/imx6ul_var_dart_mmc_defconfig
@@ -7,7 +7,7 @@ CONFIG_SPL_GPIO=y
 CONFIG_SPL_LIBCOMMON_SUPPORT=y
 CONFIG_SPL_LIBGENERIC_SUPPORT=y
 CONFIG_NR_DRAM_BANKS=8
-CONFIG_ENV_SIZE=0x2000
+CONFIG_ENV_SIZE=0x4000
 CONFIG_ENV_OFFSET=0xE0000
 CONFIG_MX6UL=y
 CONFIG_TARGET_IMX6UL_VAR_DART=y
@@ -23,7 +23,7 @@ CONFIG_FIT=y
 CONFIG_SPL_LOAD_FIT=y
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_BOOTDELAY=1
-CONFIG_BOOTCOMMAND="run ramsize_check; mmc dev ${mmcdev}; mmc dev ${mmcdev}; if mmc rescan; then if run loadbootenv; then run importbootenv; fi; if run loadbootscript; then run bootscript; else if run loadimage; then run mmcboot; else run netboot; fi; fi; else run netboot; fi"
+CONFIG_BOOTCOMMAND="setenv resin_kernel_load_addr ${loadaddr}; run resin_set_kernel_root; run set_os_cmdline; setenv mmcdev ${resin_dev_index}; setenv mmcbootpart ${resin_boot_part}; run ramsize_check; mmc rescan; if mmc dev 0; then setenv boot_dev sd; else if mmc dev 1; then setenv boot_dev emmc; fi; fi; mmc dev ${mmcdev}; if run loadimage; then run mmcboot; fi;"
 CONFIG_SYS_PBSIZE=532
 CONFIG_SILENT_CONSOLE=y
 # CONFIG_SPL_SILENT_CONSOLE is not set
diff --git a/include/configs/imx6ul_var_dart.h b/include/configs/imx6ul_var_dart.h
index f09b8c1ea0f..6476ef81f81 100644
--- a/include/configs/imx6ul_var_dart.h
+++ b/include/configs/imx6ul_var_dart.h
@@ -71,25 +71,32 @@
 	"mmcbootpart=1\0" \
 	"mmcrootpart=2\0" \
 	"mmcargs=setenv bootargs console=${console},${baudrate} " \
-		"root=/dev/mmcblk${mmcblk}p${mmcrootpart} rootwait rw " \
+		"${resin_kernel_root} rootwait rw ${os_cmdline} " \
 		"${cma_size}\0" \
 	"loadbootenv=" \
 		"load mmc ${mmcdev}:${mmcbootpart} ${loadaddr} ${bootdir}/${bootenv}\0" \
 	"importbootenv=echo Importing bootenv from mmc ...; " \
 		"env import -t ${loadaddr} ${filesize}\0" \
 	"loadbootscript=" \
-		"load mmc ${mmcdev}:${mmcbootpart} ${loadaddr} ${bootdir}/${script};\0" \
+		"load mmc ${resin_dev_index}:${resin_boot_part} ${loadaddr} ${bootdir}/${script};\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
 		"source\0" \
 	"loadimage=load mmc ${mmcdev}:${mmcbootpart} ${loadaddr} ${bootdir}/${image}\0" \
+	"loadimage=if load ${resin_dev_type} ${resin_dev_index}:${resin_root_part} ${loadaddr} boot/${image}; then run balena_kernel_load_crc_save; echo Loaded ${image} from rootfs; " \
+		"else if load ${resin_dev_type} ${resin_dev_index}:${resin_boot_part} ${loadaddr} ${image}; then  run balena_kernel_load_crc_save; echo Loaded ${image} from boot partition; " \
+		"else echo Failed to load ${image}; fi; fi; \0" \
 	"loadfdt=run findfdt; " \
 		"echo fdt_file=${fdt_file}; " \
-		"load mmc ${mmcdev}:${mmcbootpart} ${fdt_addr} ${bootdir}/${fdt_file}\0" \
-	"mmcboot=echo Booting from mmc ...; " \
+		"if load ${resin_dev_type} ${resin_dev_index}:${resin_root_part} ${fdt_addr} boot/${fdt_file}; then run balena_fdt_load_crc_save; echo Loaded ${fdt_file} from rootfs; " \
+		"else if load ${resin_dev_type} ${resin_dev_index}:${resin_boot_part} ${fdt_addr} ${fdt_file}; then run balena_fdt_load_crc_save; echo Loaded ${fdt_file} from boot partition; " \
+		"else echo Failed to load ${fdt_file}; fi; fi; \0" \
+	"mmcboot=echo Booting from ${resin_dev_type} ...; " \
 		"run mmcargs; " \
 		"run optargs; " \
 		"if test \"${boot_fdt}\" = yes || test \"${boot_fdt}\" = try; then " \
 			"if run loadfdt; then " \
+				"run balena_kernel_load_crc_check; " \
+				"run balena_fdt_load_crc_check; " \
 				"bootz ${loadaddr} - ${fdt_addr}; " \
 			"else " \
 				"if test \"${boot_fdt}\" = try; then " \
-- 
2.34.1

